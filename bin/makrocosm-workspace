#!/bin/sh

set -e
[ "$VERBOSE_WORKSPACE" != 1 ] || set -x

WORKSPACE="$1"
shift

WORKSPACE_IMAGE_REF="$(head -1 "build/$WORKSPACE")"
if [ -z "$WORKSPACE_IMAGE_REF" ] || ! docker image inspect "$WORKSPACE_IMAGE_REF" 2>/dev/null 1>&2; then
  exec "$@"
  exit 1
fi

envfile="$(mktemp)"
trap 'rm $envfile' EXIT
env | egrep -v '^[^=]*(PATH|SSH_AUTH_SOCK)=' > "$envfile"

SSH_AGENT_ARGS=
if [ "$SSH_AUTH_SOCK" ]; then
  SSH_AGENT_ARGS="--mount=type=bind,source=$SSH_AUTH_SOCK,target=/var/run/ssh-agent.sock --env=SSH_AUTH_SOCK=/var/run/ssh-agent.sock"
fi

tty -s && TTY=-t || TTY=
docker run -i $TTY \
	--rm \
	--network=host \
	--workdir=/workspace \
	--mount=type=bind,source="$(pwd)",target=/workspace \
	--mount=type=bind,source=/tmp,target=/tmp \
	--mount=type=bind,source=/var/run/docker.sock,target=/var/run/docker.sock \
	--group-add="$(getent group docker | cut -d: -f 3)" \
	--user="$(id -u):$(id -g)" \
	--group-add=sudo \
	--env-file="$envfile" \
	--env=HOME=/home \
	$SSH_AGENT_ARGS \
	"$WORKSPACE_IMAGE_REF" \
	"$@"
